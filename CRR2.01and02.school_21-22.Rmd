---
title: "Report Year 21-22 CRR2.school sheets " 
subtitle: "Script for CTE Data Analysts / Report Preparer"
author: "Rebecca Amodeo & Liz Rain"
date: "`r format(Sys.time(), '%X, %d %B, %Y')`"
output:
  html_document:
    theme: sandstone
    toc: true
    toc_float:
      collapsed: false 
    number_sections: true 
---

```{r setup1, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(pacman) 
p_load(dplyr, here, janitor, purrr, readr, skimr, tidyr)
```

# Step 0 -- Initial Cleaning  

Import and run prelim cleaning on file from ODE BA.  

```{r setup2, include=FALSE}
schl_lvl <- read.csv(here("data", 
                          ## Need new file for this year
                          "participation_Civil_Rights_Report_agg_09222021_for2020-2021schoolyear.csv")) %>%
  clean_names() %>%
  filter(agg_lvl_cd == "S") %>%
  select(c("attnd_dist_inst_id", "attnd_dist_nm",
           "attnd_schl_inst_id", "attnd_schl_nm",
           "agg_lvl_cd", "stdnt_grp_cd",
           "stdnt_grp_lbl", "tot_enrlmnt_cnt",
           "tot_demog_enrlmnt_cnt", "tot_enrlmnt_pct",
           "cte_enrlmnt_cnt", "cte_demog_enrlmnt_cnt")) %>%
  mutate(attnd_dist_inst_id = as.factor(attnd_dist_inst_id),
         attnd_dist_nm = as.factor(attnd_dist_nm),
         attnd_schl_inst_id = as.factor(attnd_schl_inst_id),
         attnd_schl_nm = as.factor(attnd_schl_nm),
         stdnt_grp_cd = as.factor(stdnt_grp_cd), 
         stdnt_grp_lbl = as.factor(stdnt_grp_lbl),
         attnd_dist_inst_id = as.factor(attnd_dist_inst_id))

thelabels <- as.data.frame(unique(schl_lvl$stdnt_grp_lbl)) %>%
  rename(studentgrouplabelfromBA = 1)
```

# Step 1  -- Locally Define Cols  

Vector names for CRR2 in `CRR2.01and02.school_XX-YY.Rmd` are the end position column name in the .csv or .xlsx file. The column-position-to-descriptive-label relationships are all specified each report year in `CRR1`.   

# Step 2  -- Build Row Base  

Row Base columns are:  
- A == District ID (Non-Perkins!)   

- B == District Name  

- C == School ID  

- D == School Name
```{r step02, echo = FALSE}
basecols <- schl_lvl %>%
  select(c("attnd_dist_inst_id", "attnd_dist_nm",
           "attnd_schl_inst_id", "attnd_schl_nm")) %>%
  distinct() %>%
  rename(A = attnd_dist_inst_id,
         B = attnd_dist_nm,
         C = attnd_schl_inst_id,
         D = attnd_schl_nm) %>%
  mutate(matchid = paste0(A, "-", C)) %>% #match on inst-id combo
  arrange(B, D) #Viz organized A-Z by NAMES
```


# Step 3 -- Locally Define FSGs   

FSG == Focal Student Group       

```{r step03, echo = FALSE} 
schl_lvl <- schl_lvl %>% 
  mutate(crrfsg_a = if_else(stdnt_grp_lbl %in% c("Female", "Non-Binary"), 
                            "notmale",
                    if_else(stdnt_grp_lbl == "Male", "ismale",
                    if_else(stdnt_grp_lbl == "Minority", "notwhtonly", 
                    if_else(stdnt_grp_lbl == "White", "iswhtonly",
                    if_else(stdnt_grp_lbl %in% c("Students With Disabilities", 
                                                   "Section 504 Students"), "swd",
                    if_else(stdnt_grp_lbl == "English Learners", "ELYes", 
                              "NAForCRR2")      ))))),
         crrfsg_b = if_else(stdnt_grp_lbl %in% c("Female", "Male", "Non-Binary"), 
                            "forFSGTot", "NAForCRR2")     ) %>% 
  replace(.=="NAForCRR2", NA) 

 # keep it nice :) 
rm(thelabels)
```


# Step 4 -- FSG Counts in School   

```{r step04, echo = FALSE}
draftCRR2a <- schl_lvl %>% 
  group_by(attnd_dist_inst_id, attnd_schl_inst_id, crrfsg_a) %>% 
  summarise(FSGSubsetCountINSCHL = sum(tot_demog_enrlmnt_cnt, na.rm = TRUE)) %>%
  filter(!is.na(crrfsg_a)) %>%
  pivot_wider(id_cols = 1:2, 
              names_from = crrfsg_a,
              names_prefix = "fsgcountINSCHL",
              values_from = FSGSubsetCountINSCHL) %>% 
  ungroup() %>%
  mutate(matchid = paste0(attnd_dist_inst_id, "-", attnd_schl_inst_id)) %>% 
  select(fsgcountINSCHLELYes:matchid)

draftCRR2b <- schl_lvl %>% 
  group_by(attnd_dist_inst_id, attnd_schl_inst_id, crrfsg_b) %>% 
  summarise(FSGTotCountINSCHL = sum(tot_demog_enrlmnt_cnt, na.rm = TRUE)) %>%
  filter(!is.na(crrfsg_b)) %>% 
  mutate(matchid = paste0(attnd_dist_inst_id, "-", attnd_schl_inst_id)) %>% 
  ungroup() %>%
  select(FSGTotCountINSCHL, matchid) %>%
  full_join(draftCRR2a, by = c("matchid")) 

 # keep it nice :) 
rm(draftCRR2a)

```

# Step 5 -- FSG Counts in CTE  

```{r step05, echo = FALSE}
draftCRR2c <- schl_lvl %>% 
  group_by(attnd_dist_inst_id, attnd_schl_inst_id, crrfsg_a) %>% 
  summarise(FSGSubsetCountINCTE = sum(cte_demog_enrlmnt_cnt, na.rm = TRUE)) %>%
  filter(!is.na(crrfsg_a)) %>%
  pivot_wider(id_cols = 1:2, 
              names_from = crrfsg_a,
              names_prefix = "fsgcountINCTE",
              values_from = FSGSubsetCountINCTE) %>% 
  ungroup() %>%
  mutate(matchid = paste0(attnd_dist_inst_id, "-", attnd_schl_inst_id)) %>% 
  select(fsgcountINCTEELYes:matchid)

draftCRR2d <- schl_lvl %>% 
  group_by(attnd_dist_inst_id, attnd_schl_inst_id, crrfsg_b) %>% 
  summarise(FSGTotCountINCTE = sum(cte_demog_enrlmnt_cnt, na.rm = TRUE)) %>%
  filter(!is.na(crrfsg_b)) %>% 
  mutate(matchid = paste0(attnd_dist_inst_id, "-", attnd_schl_inst_id)) %>% 
  ungroup() %>%
  select(FSGTotCountINCTE, matchid) %>%
  full_join(draftCRR2c, by = c("matchid")) %>%
  full_join(draftCRR2b, by = c("matchid")) 

 # keep it nice :) 
rm(draftCRR2b, draftCRR2c) 
```

# Step 6 -- Rates of Representation  

```{r step06, echo = FALSE}
draftCRR2d <- draftCRR2d  %>% 
  mutate(fsgRORinSCHLELYes = fsgcountINSCHLELYes/FSGTotCountINSCHL,
         fsgRORinSCHLismale = fsgcountINSCHLismale/FSGTotCountINSCHL,
         fsgRORinSCHLiswhtonly = fsgcountINSCHLiswhtonly/FSGTotCountINSCHL,
         fsgRORinSCHLnotmale = fsgcountINSCHLnotmale/FSGTotCountINSCHL,
         fsgRORinSCHLnotwhtonly = fsgcountINSCHLnotwhtonly/FSGTotCountINSCHL, 
         fsgRORinSCHLswd = fsgcountINSCHLswd/FSGTotCountINSCHL, 
         # now ROR in CTE 
         fsgRORinCTEELYes = fsgcountINCTEELYes/FSGTotCountINCTE,
         fsgRORinCTEismale = fsgcountINCTEismale/FSGTotCountINCTE,
         fsgRORinCTEiswhtonly = fsgcountINCTEiswhtonly/FSGTotCountINCTE,
         fsgRORinCTEnotmale = fsgcountINCTEnotmale/FSGTotCountINCTE,
         fsgRORinCTEnotwhtonly = fsgcountINCTEnotwhtonly/FSGTotCountINCTE, 
         fsgRORinCTEswd = fsgcountINCTEswd/FSGTotCountINCTE) 
```


# Step 7 -- DIPs  

DIPs are calculated with RORinCTE - RORinSchl.  

```{r step07, echo = FALSE}
DIPs <- draftCRR2d %>% 
  mutate(fsgDIPCTEOverSchlELYes = fsgRORinCTEELYes - fsgRORinSCHLELYes,
         fsgDIPCTEOverSchlismale = fsgRORinCTEismale - fsgRORinSCHLismale,
         fsgDIPCTEOverSchlELiswhtonly = fsgRORinCTEiswhtonly - fsgRORinSCHLiswhtonly,
         fsgDIPCTEOverSchlnotmale = fsgRORinCTEnotmale - fsgRORinSCHLnotmale,
         fsgDIPCTEOverSchlnotwhtonly = fsgRORinCTEnotwhtonly - fsgRORinSCHLnotwhtonly,
         fsgDIPCTEOverSchlswd = fsgRORinCTEswd - fsgRORinSCHLswd)

```

# Step 8 -- Sum Onsite Indicators    


Karin has requested we use two different methods of weighting FSG's over- and under-representations differently according to her moral judgement on over-representation vs. under-representation by FSG.  
```{r step08, eval = FALSE} 

## Need new listing of column positions & confirmation of the methods for onsite indicator recognition this report year
tot_onsite <- chunk_dip %>% 
  mutate(across(F1:K, abs)) %>%
  mutate(E = F1 + G + H + I + J + K) %>%
  select(attnd_schl_inst_id, E)
```

# Step 9 -- Context Cols   

```{r step09, eval = FALSE} 

## Need new listing of column positions & confirmation of the methods for onsite indicator recognition this report year 
chunk_context <- CRR_school %>%
  select(C, E:K) %>%
  mutate(across(F1:K, abs)) %>%
  mutate(AL = F1/E, 
         AM = G/E, 
         AN = H/E, 
         AO = I/E, 
         AP = J/E, 
         AQ = K/E) %>%
  select(c(C, AL, AM, AN, AO, AP, AQ)) %>%
  mutate(AR = AL + AM + AN + AO + AP + AQ)

CRR2p01 <- CRR_school %>%
  left_join(chunk_context, by = "C") %>%
  arrange(desc(E)) %>%
  mutate(row_num = rank(desc(E),
                        na.last = TRUE,
                        ties.method = "random")) 


## This requires additional correction on the filter. 
CRR2p02 <- CRR_school %>%
  filter(!grepl("Middle School|Jr High|Junior High|Elementary|K-8", D)) %>%
  mutate(row_num = rank(desc(E),
                        na.last = TRUE,
                        ties.method = "random")) #
```

# Step 10 -- Add Rank Cols  

```{r step10, eval = FALSE}

## Need new listing of column positions & confirmation of the methods for onsite indicator recognition this report year 
```


# Step 11 -- Write Files   

```{r step11, eval = FALSE} 

## Need new listing of column positions & confirmation of the methods for onsite indicator recognition this report year 
write.csv(CRR2p01, file = here("output", "output_21-22_CRR2.01_", Sys.Date(), ".csv")) 

write.csv(CRR2p02, file = here("output", "output_21-22_CRR2.02_", Sys.Date(), ".csv")) 
```
